{"version":3,"file":"jobs.js","sourceRoot":"","sources":["../../src/jobs.ts"],"names":[],"mappings":";;;AAYA;;;;GAIG;AACH,MAAa,GAAG;IACJ,GAAG,CAAS;IACZ,GAAG,CAAqB;IACxB,kBAAkB,CAEH;IACf,eAAe,CAAuC;IACtD,OAAO,GAAY,KAAK,CAAC;IACzB,OAAO,CAAyB;IAE1C;;OAEG;IACH,YACE,EAAsB,EACtB,EAAU,EACV,iBAEwB,EACxB,cAAoD;QAEpD,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC;QACd,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC;QACd,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;QAC5C,IAAI,CAAC,eAAe,GAAG,cAAc,CAAC;IACxC,CAAC;IAED;;OAEG;IACH,IAAI,QAAQ;QACV,OAAO,IAAI,CAAC,GAAG,CAAC;IAClB,CAAC;IAED;;OAEG;IACH,IAAI,EAAE;QACJ,OAAO,IAAI,CAAC,GAAG,CAAC;IAClB,CAAC;IAED;;;OAGG;IACH,IAAI,QAAQ;QACV,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAED;;OAEG;IACH,IAAI,MAAM;QACR,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAED;;;;;;;;;;;;;;OAcG;IACH,KAAK,CAAC,IAAI;QACR,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YACnB,IAAI,GAAiC,CAAC;YACtC,IAAI,CAAC;gBACH,GAAG,GAAG,MAAM,IAAI,CAAC,GAAG,CAAC,OAAO,CAC1B;oBACE,MAAM,EAAE,KAAK;oBACb,QAAQ,EAAE,aAAa,IAAI,CAAC,GAAG,EAAE;iBAClC,EACD,KAAK,CACN,CAAC;YACJ,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;oBACzB,OAAO,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC;gBACjC,CAAC;gBACD,MAAM,CAAC,CAAC;YACV,CAAC;YACD,IAAI,GAAG,CAAC,MAAM,KAAK,GAAG,EAAE,CAAC;gBACvB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;gBACpB,IAAI,IAAI,CAAC,kBAAkB,EAAE,CAAC;oBAC5B,IAAI,CAAC,OAAO,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,CAAC;gBACpD,CAAC;qBAAM,CAAC;oBACN,IAAI,CAAC,OAAO,GAAG,GAAG,CAAC,UAAU,CAAC;gBAChC,CAAC;YACH,CAAC;QACH,CAAC;QACD,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAED;;;OAGG;IACH,MAAM;QACJ,OAAO,IAAI,CAAC,GAAG,CAAC,OAAO,CACrB;YACE,MAAM,EAAE,KAAK;YACb,QAAQ,EAAE,aAAa,IAAI,CAAC,GAAG,SAAS;SACzC,EACD,GAAG,EAAE,CAAC,SAAS,CAChB,CAAC;IACJ,CAAC;IAED;;OAEG;IACH,YAAY;QACV,OAAO,IAAI,CAAC,GAAG,CAAC,OAAO,CACrB;YACE,MAAM,EAAE,QAAQ;YAChB,QAAQ,EAAE,aAAa,IAAI,CAAC,GAAG,EAAE;SAClC,EACD,GAAG,EAAE,CAAC,SAAS,CAChB,CAAC;IACJ,CAAC;IAED;;;;;;;;;;;;;;;OAeG;IACH,YAAY;QACV,OAAO,IAAI,CAAC,GAAG,CAAC,OAAO,CACrB;YACE,QAAQ,EAAE,aAAa,IAAI,CAAC,GAAG,EAAE;SAClC,EACD,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,MAAM,KAAK,GAAG,CAC5B,CAAC;IACJ,CAAC;CACF;AAvJD,kBAuJC","sourcesContent":["/**\n * ```ts\n * import type { Job } from \"arangojs/jobs\";\n * ```\n *\n * The \"jobs\" module provides job-related types for TypeScript.\n *\n * @packageDocumentation\n */\nimport * as connection from \"./connection.js\";\nimport * as databases from \"./databases.js\";\n\n/**\n * Represents an async job in a {@link databases.Database}.\n *\n * @param ResultType - The type of the job's result.\n */\nexport class Job<ResultType = any> {\n  protected _id: string;\n  protected _db: databases.Database;\n  protected _transformResponse?: (\n    res: connection.ProcessedResponse,\n  ) => Promise<ResultType>;\n  protected _transformError?: (error: any) => Promise<ResultType>;\n  protected _loaded: boolean = false;\n  protected _result: ResultType | undefined;\n\n  /**\n   * @internal\n   */\n  constructor(\n    db: databases.Database,\n    id: string,\n    transformResponse?: (\n      res: connection.ProcessedResponse,\n    ) => Promise<ResultType>,\n    transformError?: (error: any) => Promise<ResultType>,\n  ) {\n    this._db = db;\n    this._id = id;\n    this._transformResponse = transformResponse;\n    this._transformError = transformError;\n  }\n\n  /**\n   * Database this job belongs to.\n   */\n  get database() {\n    return this._db;\n  }\n\n  /**\n   * The job's ID.\n   */\n  get id(): string {\n    return this._id;\n  }\n\n  /**\n   * Whether the job's results have been loaded. If set to `true`, the job's\n   * result can be accessed from {@link Job.result}.\n   */\n  get isLoaded(): boolean {\n    return this._loaded;\n  }\n\n  /**\n   * The job's result if it has been loaded or `undefined` otherwise.\n   */\n  get result(): ResultType | undefined {\n    return this._result;\n  }\n\n  /**\n   * Loads the job's result from the database if it is not already loaded.\n   *\n   * @example\n   * ```js\n   * // poll for the job to complete\n   * while (!job.isLoaded) {\n   *   await timeout(1000);\n   *   const result = await job.load();\n   *   console.log(result);\n   * }\n   * // job result is now loaded and can also be accessed from job.result\n   * console.log(job.result);\n   * ```\n   */\n  async load(): Promise<ResultType | undefined> {\n    if (!this.isLoaded) {\n      let res: connection.ProcessedResponse;\n      try {\n        res = await this._db.request(\n          {\n            method: \"PUT\",\n            pathname: `/_api/job/${this._id}`,\n          },\n          false,\n        );\n      } catch (e) {\n        if (this._transformError) {\n          return this._transformError(e);\n        }\n        throw e;\n      }\n      if (res.status !== 204) {\n        this._loaded = true;\n        if (this._transformResponse) {\n          this._result = await this._transformResponse(res);\n        } else {\n          this._result = res.parsedBody;\n        }\n      }\n    }\n    return this._result;\n  }\n\n  /**\n   * Cancels the job if it is still running. Note that it may take some time to\n   * actually cancel the job.\n   */\n  cancel(): Promise<void> {\n    return this._db.request(\n      {\n        method: \"PUT\",\n        pathname: `/_api/job/${this._id}/cancel`,\n      },\n      () => undefined,\n    );\n  }\n\n  /**\n   * Deletes the result if it has not already been retrieved or deleted.\n   */\n  deleteResult(): Promise<void> {\n    return this._db.request(\n      {\n        method: \"DELETE\",\n        pathname: `/_api/job/${this._id}`,\n      },\n      () => undefined,\n    );\n  }\n\n  /**\n   * Fetches the job's completion state.\n   *\n   * Returns `true` if the job has completed, `false` otherwise.\n   *\n   * @example\n   * ```js\n   * // poll for the job to complete\n   * while (!(await job.getCompleted())) {\n   *   await timeout(1000);\n   * }\n   * // job result is now available and can be loaded\n   * await job.load();\n   * console.log(job.result);\n   * ```\n   */\n  getCompleted(): Promise<boolean> {\n    return this._db.request(\n      {\n        pathname: `/_api/job/${this._id}`,\n      },\n      (res) => res.status !== 204,\n    );\n  }\n}\n"]}